<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù‚Ø§Ù…ÙˆØ³ÙŠ Ø§Ù„ØµÙˆØªÙŠ</title>
<style>
  body{
    margin:0;
    font-family:Tahoma, Arial;
    background:#0f172a;
    color:#fff;
    text-align:center;
    padding:18px;
  }
  h2{margin:10px 0 6px}
  .sub{font-size:12px;color:#b7c3e6;margin-bottom:14px;line-height:1.6}
  .mic{
    width:190px;height:190px;border-radius:999px;
    border:0; cursor:pointer;
    background:#2563eb;color:#fff;
    font-size:44px;
    display:block;margin:14px auto 10px;
  }
  .mic:active{transform:scale(.97)}
  .card{
    max-width:520px;
    margin:12px auto;
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:14px;
  }
  #result{
    font-size:34px;
    margin-top:6px;
    min-height:44px;
  }
  #status{
    font-size:13px;
    color:#38bdf8;
    min-height:18px;
    margin-top:6px;
  }
  .row{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }
  input[type="range"]{
    width:min(320px, 90%);
  }
  .badge{
    font-size:12px;
    color:#b7c3e6;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    border-radius:999px;
    padding:6px 10px;
  }
</style>
</head>
<body>

<h2>ğŸ¤ Ù‚Ø§Ù…ÙˆØ³ÙŠ Ø§Ù„ØµÙˆØªÙŠ</h2>
<div class="sub">Ù‚Ù„: â€œØ£Ø¨ØºÙ‰ ÙƒÙ„Ù…Ø© â€¦ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠâ€</div>

<button class="mic" onclick="startListening()">ğŸ¤</button>

<div class="card">
  <div class="row">
    <span class="badge">ğŸ¢ Ø¨Ø·ÙŠØ¡</span>
    <input id="rate" type="range" min="0.6" max="1.0" step="0.05" />
    <span class="badge">ğŸ™‚ Ø·Ø¨ÙŠØ¹ÙŠ</span>
  </div>
  <div class="sub">Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø·Ù‚: <span id="rateVal"></span></div>

  <div id="status"></div>
  <div id="result">â€”</div>
</div>

<script>
let DICT = {};

async function loadDictionary(){
  const res = await fetch("./dictionary_ar_en.json", { cache:"no-store" });
  if(!res.ok) throw new Error("Ù„Ù… Ø£Ø¬Ø¯ Ù…Ù„Ù Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ dictionary_ar_en.json");
  DICT = await res.json();
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù…Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ù‚ØµÙˆØ¯Ø©
function cleanWord(text){
  if(!text) return "";
  text = text
    .replace(/Ø£Ø¨ØºÙ‰|Ø§Ø¨ØºÙ‰/gi, "")
    .replace(/ÙƒÙ„Ù…Ø©/gi, "")
    .replace(/Ø¨Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ|Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ|Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ|Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ|Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ/gi, "")
    .replace(/[ØŸ?!.ØŒ,:;"]/g, " ")
    .trim();

  // Ø¥Ø²Ø§Ù„Ø© "Ø§Ù„Ù€" ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if(text.startsWith("Ø§Ù„") && text.length > 2){
    text = text.substring(2);
  }
  return text.trim();
}

// ====== Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…Ù† 0.6 Ø¥Ù„Ù‰ 1.0 ÙÙ‚Ø·) ======
const rateSlider = document.getElementById("rate");
const rateVal = document.getElementById("rateVal");

function getRate(){
  // Ù…Ù†Ø¹ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù† 1 Ø­ØªÙ‰ Ù„Ùˆ Ø­ØµÙ„ ØªÙ„Ø§Ø¹Ø¨
  const r = Math.min(1.0, Math.max(0.6, parseFloat(rateSlider.value || "0.8")));
  return r;
}

function setRateUI(r){
  const safe = Math.min(1.0, Math.max(0.6, r));
  rateSlider.value = safe.toFixed(2);
  rateVal.textContent = safe.toFixed(2);
  localStorage.setItem("tts_rate", String(safe));
}

rateSlider.addEventListener("input", () => {
  setRateUI(getRate());
});

// Ù†Ø·Ù‚ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø¨Ø·Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
function speakEnglish(word){
  if(!word) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(word);
  u.lang = "en-US";
  u.rate = getRate();      // ğŸ‘ˆ Ù‡Ù†Ø§ Ø§Ù„ØªØ­ÙƒÙ…
  u.pitch = 1.0;
  u.volume = 1.0;
  speechSynthesis.speak(u);
}

function startListening(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    alert("ÙŠÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„.");
    return;
  }

  const recog = new SpeechRecognition();
  recog.lang = "ar-SA";
  recog.interimResults = false;

  document.getElementById("status").textContent = "ğŸ§ Ø£Ø³Ù…Ø¹Ùƒ...";
  recog.start();

  recog.onresult = (event) => {
    const spoken = event.results?.[0]?.[0]?.transcript || "";
    document.getElementById("status").textContent = "Ø³Ù…Ø¹Øª: " + spoken;

    const arWord = cleanWord(spoken);
    const enWord = DICT[arWord];

    if(enWord){
      document.getElementById("result").textContent = enWord;
      speakEnglish(enWord);
    }else{
      document.getElementById("result").textContent = "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
    }
  };

  recog.onerror = () => {
    document.getElementById("status").textContent = "âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø°Ù† Ø§Ù„Ù…Ø§ÙŠÙƒ.";
  };
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
window.onload = async () => {
  // Ø³Ø±Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© + Ø­ÙØ¸
  const saved = parseFloat(localStorage.getItem("tts_rate") || "0.8");
  setRateUI(isFinite(saved) ? saved : 0.8);

  try{
    await loadDictionary();
    document.getElementById("status").textContent = "Ø¬Ø§Ù‡Ø² âœ…";
  }catch(e){
    document.getElementById("status").textContent = "Ø®Ø·Ø£: " + e.message;
  }
};
</script>

</body>
</html>
